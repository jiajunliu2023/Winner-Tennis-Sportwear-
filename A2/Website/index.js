// Only login as customer to leave review
// Use the product name to fetch the product details and product review
function showHome(){
    document.getElementById("products").style.display = "block";
    document.getElementById("register").style.display ="none";
    document.getElementById("login").style.display ="none";
    document.getElementById("Refund").style.display = "none";
    document.getElementById("DeliveryMethod").style.display = "none";
    document.getElementById("RefundForm").style.display ="none";
    document.getElementById("productDetail").style.display ="none";
    document.getElementById("addproject").style.display ="none";
    document.getElementById("updateProduct").style.display ="none";
    document.getElementById("deleteProduct").style.display ="none";
    document.getElementById("RefundRequest").style.display="none";
    document.getElementById("reviews").style.display = "none";
    document.getElementById("ShoppingCart").style.display = "none";
    document.getElementById("PastOrders").style.display = "none";
}

function showLogin(){
    document.getElementById("register").style.display ="none";
    document.getElementById("login").style.display ="block";
    document.getElementById("Refund").style.display = "none";
    document.getElementById("DeliveryMethod").style.display = "none";
    document.getElementById("RefundForm").style.display ="none";
    document.getElementById("products").style.display = "none";
    document.getElementById("productDetail").style.display ="none";
    document.getElementById("addproject").style.display ="none";
    document.getElementById("updateProduct").style.display ="none";
    document.getElementById("deleteProduct").style.display ="none";
    document.getElementById("RefundRequest").style.display="none";
    document.getElementById("reviews").style.display = "none";
    document.getElementById("ShoppingCart").style.display = "none";
    document.getElementById("PastOrders").style.display = "none";

}

function showRegister(){
    document.getElementById("register").style.display ="block";
    document.getElementById("login").style.display ="none";
    document.getElementById("Refund").style.display = "none";
    document.getElementById("DeliveryMethod").style.display = "none";
    document.getElementById("RefundForm").style.display ="none";
    document.getElementById("products").style.display = "none";
    document.getElementById("productDetail").style.display ="none";
    document.getElementById("addproject").style.display ="none";
    document.getElementById("updateProduct").style.display ="none";
    document.getElementById("deleteProduct").style.display ="none";
    document.getElementById("RefundRequest").style.display="none";
    document.getElementById("reviews").style.display = "none";
    document.getElementById("ShoppingCart").style.display = "none";
    document.getElementById("PastOrders").style.display = "none";
    

}
function showrefund(){
    document.getElementById("Refund").style.display = "block";
    document.getElementById("register").style.display ="none";
    document.getElementById("login").style.display ="none";
    document.getElementById("DeliveryMethod").style.display = "none";
    document.getElementById("RefundForm").style.display ="none";
    document.getElementById("products").style.display = "none";
    document.getElementById("productDetail").style.display ="none";
    document.getElementById("addproject").style.display ="none";
    document.getElementById("updateProduct").style.display ="none";
    document.getElementById("deleteProduct").style.display ="none";
    document.getElementById("RefundRequest").style.display="none";
    document.getElementById("reviews").style.display = "none";
    document.getElementById("ShoppingCart").style.display = "none";
    document.getElementById("PastOrders").style.display = "none";

}

function showDeliveryMethod(){
    document.getElementById("DeliveryMethod").style.display = "block";
    document.getElementById("Refund").style.display = "none";
    document.getElementById("register").style.display ="none";
    document.getElementById("login").style.display ="none";
    document.getElementById("RefundForm").style.display ="none";
    document.getElementById("products").style.display = "none";
    document.getElementById("productDetail").style.display ="none";
    document.getElementById("addproject").style.display ="none";
    document.getElementById("updateProduct").style.display ="none";
    document.getElementById("deleteProduct").style.display ="none";
    document.getElementById("RefundRequest").style.display="none";
    document.getElementById("reviews").style.display = "none";
    document.getElementById("ShoppingCart").style.display = "none";
    document.getElementById("PastOrders").style.display = "none";
}

function showRefundForm(){
    document.getElementById("RefundForm").style.display ="block";
    document.getElementById("register").style.display ="none";
    document.getElementById("login").style.display ="none";
    document.getElementById("Refund").style.display = "none";
    document.getElementById("DeliveryMethod").style.display = "none";
    document.getElementById("products").style.display = "none";
    document.getElementById("productDetail").style.display ="none";
    document.getElementById("addproject").style.display ="none";
    document.getElementById("updateProduct").style.display ="none";
    document.getElementById("deleteProduct").style.display ="none";
    document.getElementById("RefundRequest").style.display="none";
    document.getElementById("reviews").style.display = "none";
    document.getElementById("ShoppingCart").style.display = "none";
    document.getElementById("PastOrders").style.display = "none";
    
}

function showAddProduct(){
    document.getElementById("products").style.display = "none";
    document.getElementById("register").style.display ="none";
    document.getElementById("login").style.display ="none";
    document.getElementById("Refund").style.display = "none";
    document.getElementById("DeliveryMethod").style.display = "none";
    document.getElementById("RefundForm").style.display ="none";
    document.getElementById("productDetail").style.display ="none";
    document.getElementById("addproject").style.display ="block";
    document.getElementById("updateProduct").style.display ="none";
    document.getElementById("deleteProduct").style.display ="none";
    document.getElementById("RefundRequest").style.display="none";
    document.getElementById("reviews").style.display = "none";
    document.getElementById("ShoppingCart").style.display = "none";
    document.getElementById("PastOrders").style.display = "none";
}

function showUpdateProduct(){
    document.getElementById("products").style.display = "none";
    document.getElementById("register").style.display ="none";
    document.getElementById("login").style.display ="none";
    document.getElementById("Refund").style.display = "none";
    document.getElementById("DeliveryMethod").style.display = "none";
    document.getElementById("RefundForm").style.display ="none";
    document.getElementById("productDetail").style.display ="none";
    document.getElementById("addproject").style.display ="none";
    document.getElementById("updateProduct").style.display ="block";
    document.getElementById("deleteProduct").style.display ="none";
    document.getElementById("RefundRequest").style.display="none";
    document.getElementById("reviews").style.display = "none";
    document.getElementById("ShoppingCart").style.display = "none";
    document.getElementById("PastOrders").style.display = "none";
}

function showDeleteProduct(){
    document.getElementById("products").style.display = "none";
    document.getElementById("register").style.display ="none";
    document.getElementById("login").style.display ="none";
    document.getElementById("Refund").style.display = "none";
    document.getElementById("DeliveryMethod").style.display = "none";
    document.getElementById("RefundForm").style.display ="none";
    document.getElementById("productDetail").style.display ="none";
    document.getElementById("addproject").style.display ="none";
    document.getElementById("updateProduct").style.display ="none";
    document.getElementById("deleteProduct").style.display ="block";
    document.getElementById("RefundRequest").style.display="none";
    document.getElementById("reviews").style.display = "none";
    document.getElementById("ShoppingCart").style.display = "none";
    document.getElementById("PastOrders").style.display = "none";
}

function showRefundProcess(){
    document.getElementById("products").style.display = "none";
    document.getElementById("register").style.display ="none";
    document.getElementById("login").style.display ="none";
    document.getElementById("Refund").style.display = "none";
    document.getElementById("DeliveryMethod").style.display = "none";
    document.getElementById("RefundForm").style.display ="none";
    document.getElementById("productDetail").style.display ="none";
    document.getElementById("addproject").style.display ="none";
    document.getElementById("updateProduct").style.display ="none";
    document.getElementById("deleteProduct").style.display ="none";
    document.getElementById("RefundRequest").style.display="block";
    document.getElementById("reviews").style.display = "none";
    document.getElementById("ShoppingCart").style.display = "none";
    document.getElementById("PastOrders").style.display = "none";

}

function showShoppingCart() {
    document.getElementById("ShoppingCart").style.display = "block";
    document.getElementById("products").style.display = "none";
    document.getElementById("register").style.display = "none";
    document.getElementById("login").style.display = "none";
    document.getElementById("Refund").style.display = "none";
    document.getElementById("DeliveryMethod").style.display = "none";
    document.getElementById("RefundForm").style.display = "none";
    document.getElementById("productDetail").style.display = "none";
    document.getElementById("addproject").style.display = "none";
    document.getElementById("updateProduct").style.display = "none";
    document.getElementById("deleteProduct").style.display = "none";
    document.getElementById("RefundRequest").style.display = "none";
    document.getElementById("reviews").style.display = "none";
    document.getElementById("PastOrders").style.display = "none";


}

function showPastOrders() {
    document.getElementById("PastOrders").style.display = "block";
    document.getElementById("ShoppingCart").style.display = "none";
    document.getElementById("products").style.display = "none";
    document.getElementById("register").style.display = "none";
    document.getElementById("login").style.display = "none";
    document.getElementById("Refund").style.display = "none";
    document.getElementById("DeliveryMethod").style.display = "none";
    document.getElementById("RefundForm").style.display = "none";
    document.getElementById("productDetail").style.display = "none";
    document.getElementById("addproject").style.display = "none";
    document.getElementById("updateProduct").style.display = "none";
    document.getElementById("deleteProduct").style.display = "none";
    document.getElementById("RefundRequest").style.display = "none";
    document.getElementById("reviews").style.display = "none";
}


const Register= () =>  {
    let customer = {
        
        "firstName": document.getElementById("FirstName").value,
        "lastName": document.getElementById("LastName").value,
        "email": document.getElementById("Email").value,
        "password": document.getElementById("Password").value,
        "address": document.getElementById("Address").value,
        "phoneNumber":document.getElementById("Phone").value
       
    }
    if (document.getElementById("FirstName").value == "") {
        alert("Please type your first name");
    }
    else if (document.getElementById("LastName").value == "") {
        alert("Please type your last name");
    }
    else if (document.getElementById("Email").value == "") {
        alert("Please type your email");
    }
    else if (document.getElementById("Password").value == "") {
        alert("Please type your password");
    }
    else if (document.getElementById("Address").value == "") {
        alert("Please type your address");
    }
    else{
    
        fetch("https://localhost:8080/api/CustomerRegister", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "accept": 'text/plain',
                'Access-Control-Allow-Origin': 'https://localhost:8080/api/CustomerRegister',
                "Access-Control-Allow-Methods": "POST",
                "Access-Control-Allow-Headers": "Content-Type, Authorization"

            },
            body: JSON.stringify(customer)
        }).then(result => result.text()).then((result) =>alert(result));
        
    
        document.getElementById("FirstName").value="";
        document.getElementById("LastName").value ="";
        document.getElementById("Email").value ="";
        document.getElementById("Password").value="";
        document.getElementById("Address").value ="";
        document.getElementById("Phone").value ="";   
        

       
    showLogin();
       
}
}
let Email = "";
let Password = "";
let IDCustomer = "";
let adminlogin = false;
let customerlogin = false;

const Login = () =>{
    if (document.getElementById("email").value == "") {
        alert("Please type your email");
    }
    else if (document.getElementById("password").value == "") {
        alert("Please type your password");
    }
    else{
    Email = document.getElementById("email").value;
    Password = document.getElementById("password").value;

    const verify = Email + ":" + Password;
    const cred = btoa(verify);

    if (Email == "Admin@winner.ac.nz" && Password == "adminwinner"){
        const r = fetch("https://localhost:8080/api/GetAdminVersion", {
            headers: {
                "authorization": "Basic " + cred,
            }
        });

        const StreamPromise = r.then((response) => {
            if (response.ok) {
                alert("Sucessful Login as Admin");
                adminlogin = true;

                document.getElementById("Loginstatus").innerHTML =`<a style="float:right" id ="Login" onclick ="Logout()">Logout</a>`;
                document.getElementById("EP").style.display ="block";
                document.getElementById("ProcessRefund").style.display ="block";
                document.getElementById("AV").style.display ="block";
                showHome();
            }
            else{
                alert("email or password incorrect, please try again");

            }
    });
    


    }
    else{
        const r = fetch("https://localhost:8080/api/GetCustomerVersion", {
                headers: {
                    "authorization": "Basic " + cred,
                }
            });

            const streamPromise = r.then((response) => {
                if (response.ok) {
                    alert("Sucessful login as Customer");

                    document.getElementById("Loginstatus").innerHTML =`<div> <a style="float:right" id ="Login" onclick ="Logout()">Logout</a></div>`;

                    customerlogin = true
                    showHome();

                    fetch(`https://localhost:8080/api/GetCustomerIDByEmail${Email}`).then(response => response.text())
                    .then(result =>{
                        IDCustomer = parseInt(result, 10);
                    });

                  
                }
                else {
                    alert("email or password incorrect, please try again");
                }
            });

    }

    document.getElementById("email").value = "";
    document.getElementById("password").value = "";

}
}

const Logout = () =>{
    alert("You have already logged out")
    adminlogin = false;
    customerlogin = false;
    document.getElementById("Loginstatus").innerHTML = `<div> <a style="float:right" id ="Login" onclick ="showLogin()">Login</a> </div>`;
    document.getElementById("EP").style.display ="none";
    document.getElementById("ProcessRefund").style.display ="none";
    document.getElementById("AV").style.display ="none";
    Email = "";
    Password = "";
    IDCustomer = "";
    showHome();
    
}

const search =()=>{
    let word = document.getElementById("Search").value;
    if (word == ""){
        GetProduct();
    }
    else{
        const FetchPromise = fetch(`https://localhost:8080/api/GetProductsByName/${word}`)

        const streamPromise = FetchPromise.then((response) => response.json());
        streamPromise.then((data)=>{
            if (data.length != 0){
                productdisplay(data);
                
            }
            else{
                document.getElementById("product").innerHTML = "";
            }
        });
    }
}

const CategoryFilter = (ProductCategory)=>{
    if (ProductCategory == "All Products"){
        GetProduct();
    }
    else{
    const FetchPromise = fetch(`https://localhost:8080/api/GetProductsByCategory/${ProductCategory}`)

        const streamPromise = FetchPromise.then((response) => response.json());
        streamPromise.then((data)=>{
            if (data.length != 0){
                productdisplay(data);
                
            }
            else{
                document.getElementById("product").innerHTML = "";
            }
        });
    }
}

const GetProduct= () =>{
    const FetchPromise = fetch('https://localhost:8080/api/ListProducts',
    {
        headers: {
            "Accept": "application/json",

        },
    }
    );

    const p = FetchPromise.then((response) => response.json());
    p.then((data)=> productdisplay(data));
}

const productdisplay = (products) =>{
    let table ="";
    let uniqueProduct = new Set();
    
    //change
    const productinformation = (product) =>{
        
        const ProductName = product.productName;
        const price = product.price;
        const discount = product.discount;
        let discoutprice;
    if (!uniqueProduct.has(ProductName)){
        uniqueProduct.add(ProductName)

        if (discount == 0){

        table += `<div class="box" onclick="showProductDetails('${ProductName}')">
                        <img src="https://localhost:8080/api/GetProductPhoto/${ProductName}" width="70%" alt="ProductPhoto">
                        <h3>${ProductName}</h3>
                        <h3>$NZ ${product.price}</h3>
                  </div>`;
        }
        else{
            discoutprice = price * (1-discount);
            table += `<div class="box" onclick="showProductDetails('${ProductName}')">
                        <img src="https://localhost:8080/api/GetProductPhoto/${ProductName}" width="70%" alt="ProductPhoto">
                        <h3>${ProductName}</h3>
                        <h3>Original Price: $NZ ${product.price}</h3>
                        <h3 style="color:red;">Current Price: $NZ${discoutprice}</h3>
                  </div>`;
        }
        

    }
}

    products.forEach((product) => 

        productinformation(product)
    );
    document.getElementById("product").innerHTML = table;
}
   


const showProductDetails = (productName) =>{
    document.getElementById("register").style.display ="none";
    document.getElementById("login").style.display ="none";
    document.getElementById("Refund").style.display = "none";
    document.getElementById("DeliveryMethod").style.display = "none";
    document.getElementById("RefundForm").style.display ="none";
    document.getElementById("products").style.display = "none";
    document.getElementById("productDetail").style.display ="block";
    document.getElementById("reviews").style.display = "block";

    fetch(`https://localhost:8080/api/GetProductsByName/${productName}`,{
        headers: {
            "Accept": "application/json",

        }, 
    }).then((response =>response.json())).then((data)=>projectdetails(data));
}
let Current_Product_Name;

// change  
const projectdetails = (products)=>{
    let colorArray = [];
    let sizeArray = [];
    const productName = products[0].productName;
    Current_Product_Name = products[0].productName;
    const description = products[0].description;
    const price = products[0].price;
    const discount = products[0].discount;
    let discountPrice;
    let table;
    if (discount == 0){
        table =`<div class="productContainer">
                    <div id ="ProductImage" id ="left">
                        <img src="https://localhost:8080/api/GetProductPhoto/${productName}" width="500px" alt="ProductPhoto">
                    </div>

                    <div id ="right">
                        <h2>${productName}</h2>
                        
                        <h2>$NZ${price}</h2>

                    `;
    }
    else{
        discountPrice = price * (1-discount);
     table =`<div class="productContainer">
                    <div id ="ProductImage" id ="left">
                        <img src="https://localhost:8080/api/GetProductPhoto/${productName}" width="500px" alt="ProductPhoto">
                    </div>

                    <div id ="right">
                        <h2>${productName}</h2>
                        <h2>Original Price: $NZ${price}</h2>
                        <h2 style="color:red;">Current Price: $NZ${discountPrice}</h2>

                    `;
    }


        const projectdetail = (product)=>{
            if (!colorArray.includes(product.color)){
                colorArray.push(product.color);
            }
            if (!sizeArray.includes(product.size)){
                sizeArray.push(product.size);
            }
        
    }
    products.forEach((product) => 

        projectdetail(product)
    );
    table += `<div class="SizeColorContainer">
                        
                    <select class="cSelect" id="Select_Color">
                        <option value="">Select the Color</option>
                            ${colorArray.map(color => `<option value="${color}">${color}</option>`).join('')}
                    </select>
            
                    <select class="sSelect" id="Select_Size">
                            <option value="">Select the Size</option>
                            ${sizeArray.map(size => `<option value="${size}">${size}</option>`).join('')}
                    </select>
                    <input type="number" id ="shoppingQuantity" placeholder="Please Enter the Quantity">

                    <button id ="ac" type="submit" onclick="AddCart()">Add to the Shopping Cart</button>
            </div>
            </div>
        </div>
        
        <div class="description">
            <h2>Description</h2>
            <p class="pd">${description}</p>
        </div>

        <div class="Form">
                <h1 style="text-align: center;">Leave Your Product Review</h1>
                <label for="username">Username</label>
                <input placeholder="Please Enter your Username" id="username" name="username" type="text" required>

                <label for="rating">Rating</label>
                <input placeholder="Please Enter your rating number (between 0 to 5)" id="rating" name="rating" type="number" required>

                <label for="comment">Comment</label>
                <textarea placeholder="Please leave your product comments" id="comment" name="comment" type="text" required rows="4" cols="50"></textarea> 

                <button type="submit" onclick="LeaveReview('${productName}')">Sumbit your product review</button>
        </div>
        
        `;

    document.getElementById("productDetail").innerHTML = table;
    showReviews(productName);

}

const LeaveReview=async (productName)=>{
    if (adminlogin == false && customerlogin == false){
        alert("Please to login to leave your comment");
        showLogin();
    }
    else if (adminlogin == true && customerlogin == false){
        alert("Only customer can leave the product review");
    }
    else if (document.getElementById("rating").value == ""){
        alert("Please enter your product rating");
    }
    else if (document.getElementById("comment").value == ""){
        alert("Please enter your product comment");
    }
    else{
        let username;
        if (document.getElementById("username").value == ""){
            username = "Anonymous";
        }
        else {
            username = document.getElementById("username").value;
        }
        if (document.getElementById("rating").value > 5 || document.getElementById("rating").value < 0) {
            alert("Please enter your product rating between 0 and 5");
            return;
        }

        let review = {
            "customerID":IDCustomer,
            "productName": productName,
            "comment": document.getElementById("comment").value,
            "username": document.getElementById("username").value,
            "rating": document.getElementById("rating").value
        }
        await fetch("https://localhost:8080/api/LeaveReview",{
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "accept": 'text/plain',
        },
        body: JSON.stringify(review)
        }).then(response => response.text()).then((response)=>alert(response));


        
        document.getElementById("comment").value = "";
        document.getElementById("username").value = "";
        document.getElementById("rating").value ="";
    }
    showReviews(productName);
}
const showReviews = (productName)=>{

    fetch(`https://localhost:8080/api/GetReviewByProduct${productName}`,{
        headers: {
            'Content-Type': 'text/plain'
        }
    }).then((output) => output.json()).then((output) => Listreviews(output));
    

}
const Listreviews = (reviews)=>{
    let ProductReview = `<div class="reviewSection">
    <h1 style="text-align: center;">Product Reviews</h1>`;
    const getreview = (review)=>{
        ProductReview +=`
            <div class="review">
                <h3>Username: ${review.username}<h3>
                <div class="ReviewComment">
                    <p>Comment: ${review.comment}</p>
                </div>

                <h3>Rate: ${review.rating} out of 5</h3>
            </div>
        `;
    }
    reviews.forEach((review)=> getreview(review));
    ProductReview +=`</div>`;
    document.getElementById("reviews").innerHTML = ProductReview;
}

const AddProduct=()=>{
    if (document.getElementById("ProductName").value == ""){
        alert("Please enter the product name");
    }
    else if (document.getElementById("Description").value == ""){
        alert("Please enter the description");
    }
    else if (document.getElementById("Category").value == ""){
        alert("Please enter the product category");
    }
    else if (document.getElementById("Price").value == ""){
        alert("Please enter the price");
    }
    else if (document.getElementById("Quantity").value == ""){
        alert("Please enter the quantity");
    }
    else if (document.getElementById("Color").value == ""){
        alert("Please enter the color");
    }
    else if (document.getElementById("Size").value == ""){
        alert("Please enter the size");
    }
    else if (document.getElementById("Discount").value == ""){
        alert("Please enter the discount");
    }
    else if (document.getElementById("image").value === ""){
        alert("Please upload the photo");
    }
    else {
        let product ={
            "productName": document.getElementById("ProductName").value,
            "description":document.getElementById("Description").value,
            "category":document.getElementById("Category").value,
            "price":document.getElementById("Price").value,
            "quantity":document.getElementById("Quantity").value,
            "color":document.getElementById("Color").value,
            "size":document.getElementById("Size").value,
            "discount":document.getElementById("Discount").value
        }
        uploadPhoto();

        fetch("https://localhost:8080/api/AddProducts",{
            method: "POST",
                headers: {

                    "Content-Type": "application/json",
                    "accept": 'text/plain',
                    'Access-Control-Allow-Origin': 'https://localhost:8080/api/AddProducts',
                    "Access-Control-Allow-Methods": "POST",
                    "Access-Control-Allow-Headers": "Content-Type, Authorization"

                },
                body: JSON.stringify(product)


            }).then(alert("Successfully add the product!"));

            document.getElementById("ProductName").value = "";
            document.getElementById("Description").value = "";
            document.getElementById("Category").value= "";
            document.getElementById("Price").value = "";
            document.getElementById("Quantity").value = "";
            document.getElementById("Color").value = "";
            document.getElementById("Size").value = "";
            document.getElementById("Discount").value = "";

            
        }
        GetProduct();
    }

    const UpdateProduct=async()=>{
        let price, quantity, discount;
        if (document.getElementById("uPrice").value == ""){
            price = -1;
        }
        else{
            price = document.getElementById("uPrice").value;
        }
        if (document.getElementById("uQuantity").value == ""){
            quantity = -1;
        }
        else{
            quantity = document.getElementById("uQuantity").value 
        }

        if (document.getElementById("uDiscount").value == ""){
            discount = -1;
        }
        else{
            discount = document.getElementById("uDiscount").value
        }

        let product ={
            "productName":document.getElementById("uProductName").value,
            "description":document.getElementById("uDescription").value,
            "category":document.getElementById("uCategory").value,
            "price":price,
            "quantity":quantity,
            "color":document.getElementById("uColor").value,
            "size":document.getElementById("uSize").value,
            "discount":discount
        }

        if (document.getElementById("uProductID").value == ""){
            alert("Please enter product id");
        }
        else {
            const productID = document.getElementById("uProductID").value;

             await fetch(`https://localhost:8080/api/GetProductByID${productID}`).then((result)=>{
                if (!result.ok){
                    alert("The Product is not identified");

                }else{
                    if (document.getElementById("uimage").value !== ""){
                        uploadPhoto();
                    }

                    fetch(`https://localhost:8080/api/UpadateProduct?ProjectID=${productID}`,{
                      
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "accept": 'text/plain',
                        "Access-Control-Allow-Methods": "POST",
                        "Access-Control-Allow-Headers": "Content-Type, Authorization"

                    },
                    body: JSON.stringify(product)

                }).then(alert("The product has been updated."))

                document.getElementById("uProductName").value = "";
                document.getElementById("uDescription").value  = "";
                document.getElementById("uCategory").value  = "";
                document.getElementById("uPrice").value  = "";
                document.getElementById("uQuantity").value  = "";
                document.getElementById("uColor").value  = "";
                document.getElementById("uSize").value =  "";
                document.getElementById("uDiscount").value  = "";
                    }
                });
                
        }
        GetProduct();
}


async function DeleteProduct(){
    const productId = document.getElementById("dProductID").value;
    if (productId == "") {
        alert("Please enter the product ID");
    }
    else {
        await fetch(`https://localhost:8080/api/DeletePrduct?ProjectID=${productId}`, {
            method: 'DELETE'
        }).then(reponse => reponse.text()).then(reponse => alert((reponse)));
        document.getElementById("dProductID").value = "";
    }
    GetProduct();
}
    

    

    


const uploadPhoto=()=>{
    const photo = document.getElementById("image").files[0];
    const formdata = new FormData();
    formdata.append("file", photo);

    fetch("https://localhost:8080/api/UploadPhoto",{
        method: "POST",
        
        body:formdata,
    }).then(response => {
        if (!response.ok){
            alert("Fail to upload photo")
        }
    });
    
}

const GetRefund =()=>{

    const FetchPromise = fetch('https://localhost:8080/api/ListRefund',
    {
      headers:{
        "Accept": "application/json",
      }
    }
    ).then((response)=> response.json()).then((data) => refundisplay(data));

}

const refundisplay = (refunds)=>{
    let table = `<div class="refundbox">
                    <table>
                    <thead>
                    <tr>
                        <th>Refund ID</th>
                        <th>Customer ID</th>
                        <th>Order ID</th>
                        <th>Refund Reason</th>
                        <th>Status</th>
                        <th></th>
                    </tr>
                    </thead>
                    </tbody>`; 

    const refundinformation = (refund)=> {
    if (refund.status == "pending"){
        table += `
                    <tr>
                        <td>${refund.refundID}</td>
                        <td>${refund.customerID}</td>
                        <td>${refund.orderID}</td>
                        <td>${refund.refundReason}</td>
                        <td>
                        <button onclick="processStatus('accept',${refund.refundID})">Accept</button>
                        <button onclick="processStatus('reject',${refund.refundID})">Reject</button>
                        </td>
                        <td>
                        <button onclick="Delete(${refund.refundID})">Delete</button>
                        </td>
                    </tr>
                `;
    }
    else{
        table += `<tr>
                    <td>${refund.refundID}</td>
                    <td>${refund.customerID}</td>
                    <td>${refund.orderID}</td>
                    <td>${refund.refundReason}</td>
                    <td>This refund request has been processed.</td>
                    <td>
                        <button onclick="Delete(${refund.refundID})">Delete</button>
                    </td>
                </tr>
               `;
    }
}
refunds.forEach((refund) => refundinformation(refund));
table += `</tbody></table> </div>`;
document.getElementById("rr").innerHTML = table;
}

const processStatus=(status, refundID)=>{

    let refund ={
        "refundID":refundID,
        "status":status
    }

    fetch("https://localhost:8080/api/ProcessRefund",{
        method: "PUT",
        headers: {
            "Content-Type": "application/json",
            "accept": 'text/plain',
        },
        body: JSON.stringify(refund)
    }).then(alert(`The process request has been ${status}ed`));

    GetRefund();

}

const ApplyRefund=()=>{
    if (adminlogin == false && customerlogin == false){
        alert("Please to login to apply for refund");
    }
    else if (adminlogin == true && customerlogin == false){
        alert("Only customer can apply for the refund");
    }
    
    else{
    
        if (document.getElementById("orderid").value == ""){
            alert("Please enter the order ID");
        }
        else if (document.getElementById("refundreason").value == ""){
            alert("Please enter the refund reason") 
        }
        else{
        
            const orderID = document.getElementById("orderid").value;
            
            

            fetch(`https://localhost:8080/api/CheckOrder?OrderID=${orderID}&CustomerID=${IDCustomer}`).then(response => response.text())
            .then(result => {
                if (result === 'false'){
                    console.log("false");
                    alert("You do not have related order");
                }
                else{
                    const CurrenttDate = new Date();


                const Year = CurrenttDate.getFullYear();

                const Month = CurrenttDate.getMonth() + 1; 

                const Day = CurrenttDate.getDate();
                
                
                const resultDate = `${Year}-${Month < 10 ? '0' : ''}${Month}-${Day < 10 ? '0' : ''}${Day}`;
                
                console.log(resultDate);  

                let refund ={
                    "customerID":IDCustomer,
                    "orderID": document.getElementById("orderid").value,
                    "date":resultDate,
                    "refundReason":document.getElementById("refundreason").value,
                }
                fetch("https://localhost:8080/api/AddRefund",{
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "accept": 'text/plain',
                },
                    body: JSON.stringify(refund)
                }).then(response => response.text()).then((response)=>alert(response));
                document.getElementById("orderid").value = "";
                document.getElementById("refundreason").value = "";
                    }
                });
            
        
        
        }
    }
    GetRefund();
}

const Delete = async (refundID)=>{
    await fetch (`https://localhost:8080/api/DeleteRefund?RefundID=${refundID}`,{
        method : 'DELETE'
        
    }).then(reponse => reponse.text()).then(reponse =>alert((reponse)));

    GetRefund();
}

async function AddCart() {
    if (customerlogin == false) {
        alert("Please login first.");
        showLogin();
    } else {
        const quantity = document.getElementById("shoppingQuantity").value;
        if (document.getElementById("Select_Color").value == "") {
            alert("Please select the color");
            return;
        } else if (document.getElementById("Select_Size").value == "") {
            alert("please select the size");
            return;
        } else if (!(parseInt(quantity) > 0)) {
            alert("please enter the quantity");
            return;
        }
        let csn = {
            "color": document.getElementById("Select_Color").value,
            "size": document.getElementById("Select_Size").value,
            "name": Current_Product_Name
        }
        let Current_Product_ID;
        await fetch(`https://localhost:8080/api/GetProductIDByColorSizeName?color=${csn.color}&size=${csn.size}&name=${csn.name}`).then(response => response.text())
            .then(result => {
                Current_Product_ID = parseInt(result, 10);
            });
        let order = {
            "customerID": IDCustomer,
            "productID_Quantity": "{" + Current_Product_ID + ":" + quantity + "}"
        }
        fetch("https://localhost:8080/api/AddOrderToCart", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "accept": 'text/plain',
                'Access-Control-Allow-Origin': 'https://localhost:8080/api/AddOrderToCart',
                "Access-Control-Allow-Methods": "POST",
                "Access-Control-Allow-Headers": "Content-Type, Authorization"

            },
            body: JSON.stringify(order)
        }).then(result => result.text()).then((result) => alert(result));
        document.getElementById("Select_Color").value = "";
        document.getElementById("Select_Size").value = "";
        document.getElementById("shoppingQuantity").value = "";
    }
}

function showCart() {
    if (customerlogin == false) {
        alert("Please Login first!");
        showLogin();
        return;
    }
    const FetchPromise = fetch('https://localhost:8080/api/GetAllCustomersCurrentOrdersByCustomerID?id=' + IDCustomer,
        {
            headers: {
                "Accept": "application/json",
            },
        }
    );

    const p = FetchPromise.then((response) => response.json());
    p.then((data) => cartdisplay(data));
}
async function cartdisplay(products) {
    let table = "";
    if (products == "") {
        table += `<h1>Your shopping cart is empty</h1>`;
        document.getElementById("shopingcart").innerHTML = table;
        showShoppingCart();
        return;
    }
    async function getdetail(product) {
        items = JSON.parse(product.productID_Quantity);
        /*        product.totalPrice*/
        for (i in items) {
            const quantity = items[i];
            await fetch(`https://localhost:8080/api/GetProductByID${i}`, {
                headers: {
                    "Accept": "application/json",

                },
            }).then((response => response.json())).then((data) => {
                let total_price = (data.price * (1 - data.discount)) * quantity;
                const roundedResult = total_price.toFixed(2);
                table += `<div class="cart">
                            <div class="cart-item">
                                <div class="item-details">
                                    <img src="https://localhost:8080/api/GetProductPhoto/${data.productName}" alt="ProductPhoto">
                                    <span class="item-name">${data.productName}</span>
                                </div>
                            </div>
                            <div class="item-quantity">Quantity: ${quantity}</div>
                            <div class="item-size">Size: ${data.size}</div>
                            <div class="item-color">Color: ${data.color}</div>
                            <div class="item-price">Price: NZ$${roundedResult}</div>
                        </div>`;
            });
        }
        if (document.getElementById("delivery").value == "standard") {
            let FinalFee = product.totalPrice.toFixed(2);
            table += `<div class="cart-total">
                    <span>Total:</span>
                    <span id="total_price">NZ$${FinalFee}</span>
                  </div>`;
            document.getElementById("shopingcart").innerHTML = table;
            showShoppingCart();
        } else if (document.getElementById("delivery").value == "express") {
            let FinalFee = (product.totalPrice + 5).toFixed(2);
            table += `<div class="cart-total">
                    <span>Total:</span>
                    <span id="total_price">NZ$${FinalFee}</span>
                  </div>`;
            document.getElementById("shopingcart").innerHTML = table;
            showShoppingCart();
        }
    }

    for (i = 0; i < products.length; i++) {
        await getdetail(products[i]);
    }
    document.getElementById("shopingcart").innerHTML = table;
    showShoppingCart();
}

/*function RenewPrice() {
    console.log(parseFloat(FinalFee) + 5);
    if (document.getElementById("delivery").value == "Online Delivery") {
        document.getElementById("total_price").innerHTML = "NZ$" + (parseFloat(FinalFee) + 5);
    } else {
        document.getElementById("total_price").innerHTML = "NZ$" + FinalFee;
    }
    showCart();
}*/

async function Checkout() {
    let order = {
        "customerID": IDCustomer,
        "date": new Date().toJSON().slice(0, 10),
        "deliverMethod": document.getElementById("delivery").value,
    }
    await fetch("https://localhost:8080/api/CheckOut", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "accept": 'text/plain',
            'Access-Control-Allow-Origin': 'https://localhost:8080/api/CheckOut',
            "Access-Control-Allow-Methods": "POST",
            "Access-Control-Allow-Headers": "Content-Type, Authorization"

        },
        body: JSON.stringify(order)
    }).then(result => result.text()).then((result) => alert(result));
    showCart();

}

function showPastorder() {
    if (customerlogin == false && adminlogin == false) {
        alert("Please Login first!");
        showLogin();
        return;
    }
    fetch('https://localhost:8080/api/GetAllCustomersPastOrdersByCustomerID?id=' + IDCustomer,
        {
            headers: {
                "Accept": "application/json",
            },
        }
    ).then((response) => response.json()).then((data) => renderOrders(data));
}

function renderOrders(orders) {
    const orderHistoryElement = document.getElementById('order-history');

    if (orders.length === 0) {
        orderHistoryElement.innerHTML = '<p>No past orders found</p>';
        showPastOrders();
        return;
    }
    const ordersHTML = orders.map(async (order) => {
        const orderDate = new Date(order.date).toLocaleDateString();
        const itemsHTMLPromise = fetchItemsForOrder(order.productID_Quantity);
        let status;
        let refund_status;
        await fetch(`https://localhost:8080/api/GetRefundByOrderID?OrderID=${order.orderID}`).then((response) => response.text()).then((data) => refund_status = data);
        if (refund_status)
/*        const refund_status = fetch(`https://localhost:8080/api/GetRefundByOrderID?OrderID=${order.orderID}`);
        const refund_status_result = refund_status.json();*/
        if (order.deliverMethod == "express"){
            status = "Dilevered";
        } else {
            status = "Picked up";
        }
        return itemsHTMLPromise.then(itemsHTML => {
            if (refund_status == "accept" || refund_status == "reject") {
                return `
        <div class="order">
          <h3>Order ID: ${order.orderID}</h3>
          <p>Date: ${orderDate}</p>
          <ul>${itemsHTML}</ul>
          <p>Total: NZD$${order.totalPrice.toFixed(2)}</p>
          <p>${status}</p>
          <p id="refund_status">Refund status: ${refund_status}</p>
        </div>
      `;
            }
            return `
        <div class="order">
          <h3>Order ID: ${order.orderID}</h3>
          <p>Date: ${orderDate}</p>
          <ul>${itemsHTML}</ul>
          <p>Total: NZD$${order.totalPrice.toFixed(2)}</p>
          <p>${status}</p>
        </div>
      `;
        });
    });

    Promise.all(ordersHTML)
        .then(ordersHTMLArray => {
            const orderPairs = [];
            for (let i = 0; i < ordersHTMLArray.length; i ++) {
                orderPairs.push(ordersHTMLArray.slice(i, i + 1));
            }

            const orderPairsHTML = orderPairs.map(pair => {
                return `<div class="order-pair">${pair.join('')}</div>`;
            });
            orderHistoryElement.innerHTML = orderPairsHTML.join('');
        })
        .catch(error => {
            console.error('Error rendering past orders:', error);
        });
    showPastOrders();
}

function fetchItemsForOrder(productidQuantity) {
    items = JSON.parse(productidQuantity);
    const itemPromises = Object.keys(items).map(productId => {
        const quantity = items[productId];
        if (typeof quantity !== 'undefined') {
            return fetch(`https://localhost:8080/api/GetProductByID${productId}`).then(response => response.json()).then(
                item => {
                    return `<li>Name: ${item.productName} <br> Price: ${item.price * (1 - item.discount)} <br> Quantity: ${quantity}</li>`;
                }
            ).catch(
                error => {
                    console.error(`Error fetching item ${productId} information:`, error);
                    return `<li>Unknown Item - ${quantity}</li>`;
                }
            );
        } else {
            console.error(`Quantity for product ${productId} is undefined`);
            return Promise.resolve('');
        }
    });

    return Promise.all(itemPromises);
}






const loading = () =>{
    GetProduct();
    GetRefund();
}
window.onload = loading;

